@page "/plan/{week:int}/{day:int}"

@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using WorkoutPlanner.Context
@using WorkoutPlanner.Model
@attribute [Authorize]
@inject UserManager<User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject DatabaseContext _context

<div class="header-container">
    <!-- Display the header with the current week and day -->
    <h3>Workout for Week @Week, Day @Day</h3>
</div>

@if (isLoading)
{
    <!-- Show a loading message while data is being fetched -->
    <p>Loading workouts...</p>
}
else if (isRestDay)
{
    <!-- Show a rest day message if it's a designated rest day -->
    <p>This is a rest day. Take it easy!</p>
}
else if (workouts != null && workouts.Any())
{
    <div class="workout-container">
       
        @foreach (var workout in workouts)
        {
            <div class="workout-card">
                <div>
                    <!-- Display or allow editing of the exercise name -->
                    <strong>Exercise Name:</strong>
                    @if (editingWorkout == workout && editingField == "ExerciseName")
                    {
                        <select value="@workout.ExerciseName" @onchange="(e) => OnExerciseNameChange(e, workout)">
                            <!-- Populate the dropdown with available exercises -->
                            @foreach (var exercise in allExercises)
                            {
                                <option value="@exercise">@exercise</option>
                            }
                        </select>
                    }
                    else
                    {
                        <span @onclick='() => StartEditing(workout, "ExerciseName")'>@workout.ExerciseName</span>
                    }
                </div>
                <div class="workout-details">
                    <!-- Display or allow editing of sets -->
                    <div>
                        <strong>Sets:</strong>
                        @if (editingWorkout == workout && editingField == "Sets")
                        {
                            <input type="number" @bind="workout.Sets" @onblur="() => SaveWorkoutAsync(workout)" />
                        }
                        else
                        {
                            <span @onclick='() => StartEditing(workout, "Sets")'>@workout.Sets</span>
                        }
                    </div>
                    <!-- Display or allow editing of reps -->
                    <div>
                        <strong>Reps:</strong>
                        @if (editingWorkout == workout && editingField == "Reps")
                        {
                            <input type="number" @bind="workout.Reps" @onblur="() => SaveWorkoutAsync(workout)" />
                        }
                        else
                        {
                            <span @onclick='() => StartEditing(workout, "Reps")'>@workout.Reps</span>
                        }
                    </div>
                    <!-- Display or allow editing of weight -->
                    <div>
                        <strong>Weight:</strong>
                        @if (editingWorkout == workout && editingField == "Weight")
                        {
                            <input type="number" @bind="workout.Weight" @onblur="() => SaveWorkoutAsync(workout)" />
                        }
                        else
                        {
                            <span @onclick='() => StartEditing(workout, "Weight")'>@workout.Weight kg</span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <!-- Display a message if no workouts are available -->
    <p>No workouts available for this day.</p>
}

<style>
    /* CSS styles for the page layout and components */
    .header-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

        .header-container h3 {
            color: #4a5c77; /* Dark dusty blue */
        }

    .workout-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-width: 500px;
        margin: 0 auto;
    }

    .workout-card {
        background-color: #f0f4f8;
        border: 1px solid #c5d1e0;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .workout-details span {
        cursor: pointer;
        border-bottom: 1px dashed #4a5c77; /* Underline to indicate editability */
    }

        .workout-details span:hover {
            color: #5b7c97; /* Highlight color */
        }

    .workout-details input,
    .workout-details select {
        width: 100px;
        margin-left: 8px;
    }
</style>

@code {
    private List<Workout> workouts = new();
    private List<string> allExercises = new(); // Store exercise names here
    private bool isLoading = true; // Indicates whether data is being loaded
    private bool isRestDay = false; // Indicates whether the current day is a rest day
    private Workout? editingWorkout = null; // The workout currently being edited
    private string? editingField = null; // The field currently being edited

    [Parameter] public int Week { get; set; } // The week parameter from the URL
    [Parameter] public int Day { get; set; } // The day parameter from the URL

    protected override async Task OnInitializedAsync()
    {
        // Fetch all available exercises from the database
        allExercises = await _context.Workouts
            .Select(w => w.ExerciseName)
            .Distinct()
            .ToListAsync();

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            // Get the current user's authentication state
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var username = authState?.User?.Identity?.Name;

            if (string.IsNullOrEmpty(username))
            {
                throw new InvalidOperationException("User not logged in.");
            }

            // Retrieve the current user
            var user = await UserManager.FindByNameAsync(username);
            if (user == null)
            {
                throw new InvalidOperationException("User not found.");
            }

            // Fetch the user's workout plans
            var weekPlans = await _context.WeekPlans
                .Include(wp => wp.Days)
                .ThenInclude(dp => dp.Workouts)
                .Where(wp => wp.UserId == user.Id)
                .ToListAsync();

            // Find the plan for the specified week
            var weekPlan = weekPlans.FirstOrDefault(w => w.WeekNumber == Week);
            if (weekPlan == null)
            {
                throw new InvalidOperationException($"No plan found for week {Week}.");
            }

            // Find the plan for the specified day
            var planForDay = weekPlan.Days.FirstOrDefault(d => d.DayNumber == Day);
            if (planForDay == null)
            {
                throw new InvalidOperationException($"No plan found for day {Day} in week {Week}.");
            }

            // Check if it's a rest day
            if (planForDay.IsRestDay)
            {
                isRestDay = true;
                workouts = new List<Workout>();
            }
            else
            {
                isRestDay = false;
                workouts = planForDay.Workouts;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            workouts = new List<Workout>();
        }
        finally
        {
            isLoading = false; // Data loading is complete
        }
    }

    private void StartEditing(Workout workout, string field)
    {
        // Begin editing the specified field of a workout
        editingWorkout = workout;
        editingField = field;
    }

    private async Task SaveWorkoutAsync(Workout workout)
    {
        try
        {
            // Save the updated workout to the database
            var workoutProvider = new WorkoutProvider(_context);
            await workoutProvider.UpdateWorkoutAsync(workout);

            // Clear the editing state
            editingWorkout = null;
            editingField = null;

            Console.WriteLine($"Workout updated: {workout.ExerciseName}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving workout: {ex.Message}");
        }
    }

    private async Task OnExerciseNameChange(ChangeEventArgs e, Workout workout)
    {
        // Handle changes to the exercise name dropdown
        workout.ExerciseName = e.Value?.ToString();
        await SaveWorkoutAsync(workout);
    }
}
